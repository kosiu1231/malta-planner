<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Planer Malty - Drag Handle</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root {
            --sidebar-width: 380px;
            --primary-color: #007bff;
            --dark-bg: #212529;
            --handle-color: #adb5bd;
        }

        body, html { margin: 0; padding: 0; height: 100%; font-family: -apple-system, Segoe UI, sans-serif; overflow: hidden; }
        #app-container { display: flex; height: 100vh; width: 100vw; position: relative; }

        /* --- SIDEBAR --- */
        #sidebar { 
            width: var(--sidebar-width); 
            background: #f8f9fa; 
            border-right: 1px solid #ddd; 
            display: flex; 
            flex-direction: column; 
            z-index: 2000;
            transition: transform 0.3s ease;
        }

        #map { flex-grow: 1; z-index: 1; height: 100%; }

        /* --- MOBILE TOGGLE --- */
        #mobile-toggle {
            display: none;
            position: absolute;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 3000;
            background: var(--dark-bg);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-weight: bold;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        @media (max-width: 768px) {
            #sidebar { position: absolute; left: 0; top: 0; height: 100%; width: 100%; transform: translateX(-100%); }
            #sidebar.open { transform: translateX(0); }
            #mobile-toggle { display: block; }
        }

        /* --- ELEMENTY LISTY --- */
        #days-container { flex-grow: 1; overflow-y: auto; padding: 10px; background: #e9ecef; }
        .day-section { background: white; border-radius: 12px; margin-bottom: 15px; border: 1px solid #ddd; overflow: hidden; }
        .day-header { background: #333; color: white; padding: 12px; font-weight: bold; }
        
        .location-item { 
            padding: 0; /* Padding przeniesiony do wewnętrznego kontenera dla lepszego D&D */
            border-bottom: 1px solid #eee; 
            display: flex; 
            align-items: center;
            background: white;
            border-left: 8px solid #ccc;
        }
        
        /* Kontener na tekst */
        .item-content {
            flex-grow: 1;
            padding: 15px 10px 15px 15px;
            cursor: pointer;
        }

        /* --- UCHWYT DRAG & DROP --- */
        .drag-handle {
            padding: 15px 20px;
            color: var(--handle-color);
            cursor: grab;
            font-size: 20px;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .drag-handle:active { cursor: grabbing; }

        .cat-nocleg { border-left-color: #007bff; }
        .cat-zabytki { border-left-color: #dc3545; }
        .badge-home { background: #28a745; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; vertical-align: middle; }

        /* HEADER & SEARCH */
        #sidebar-header { padding: 20px; background: var(--dark-bg); color: white; text-align: center; }
        #search-box { padding: 10px; display: flex; gap: 5px; background: white; border-bottom: 1px solid #ddd; }
        #search-input { flex-grow: 1; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; }
        #controls { padding: 10px; display: flex; gap: 5px; flex-wrap: wrap; background: #eee; }
        .btn { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; }

        /* MODALE */
        #login-overlay, #add-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 5000; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 350px; }
        .modal-content input, .modal-content select, .modal-content textarea { width: 100%; padding: 12px; margin-bottom: 10px; box-sizing: border-box; border-radius: 8px; border: 1px solid #ccc; }
    </style>
</head>
<body>

    <button id="mobile-toggle" onclick="toggleSidebar()">☰ MENU TRASY</button>

    <div id="login-overlay">
        <div class="modal-content" style="text-align: center;">
            <h2 style="color:black">Planer Malty</h2>
            <p id="status-init" style="color:#666">Pobieranie konfiguracji...</p>
            <input type="text" id="access-code-input" placeholder="Wpisz kod trasy" style="display:none;">
            <button class="btn" id="login-btn" style="background: #007bff; width: 100%; display:none;" onclick="handleLogin()">Otwórz</button>
        </div>
    </div>

    <div id="add-modal" style="display:none;">
        <div class="modal-content">
            <h3>Dodaj punkt</h3>
            <input type="text" id="new-name" placeholder="Nazwa miejsca">
            <select id="new-category">
                <option value="Zabytki">Zabytki</option>
                <option value="Nocleg">Nocleg (BAZA)</option>
                <option value="Jedzenie">Jedzenie</option>
                <option value="Inne">Inne</option>
            </select>
            <select id="new-day-select"></select>
            <textarea id="new-desc" placeholder="Notatki..."></textarea>
            <button class="btn" style="background: #28a745; width: 100%;" onclick="confirmAdd()">Zapisz</button>
            <button class="btn" style="background: #666; width: 100%; margin-top: 5px;" onclick="closeModal()">Anuluj</button>
        </div>
    </div>

    <div id="app-container">
        <div id="sidebar">
            <div id="sidebar-header">
                <h2 id="display-code" style="margin:0">Trasa</h2>
                <div id="status-text" style="font-size:12px; color:#4cd137">Synchronizacja...</div>
            </div>
            
            <div id="search-box">
                <input type="text" id="search-input" placeholder="Szukaj na Malcie..." onkeypress="if(event.key==='Enter') searchDirect()">
                <button class="btn" style="background:#007bff" onclick="searchDirect()">Szukaj</button>
            </div>

            <div id="controls">
                <button class="btn" style="background:#fd7e14; flex:1" onclick="syncFromDB()">Sync</button>
                <button class="btn" style="background:#6f42c1; flex:2" onclick="addNewDay()">+ Nowy dzień</button>
            </div>
            
            <div id="days-container"></div>
            
            <button class="btn" style="background:#333; margin:15px; display:block;" id="close-menu-btn" onclick="toggleSidebar()">Zamknij menu</button>
        </div>

        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <script>
        let sbClient = null;
        let USER_CODE = null;
        let locations = [];
        let maxDay = 1;
        let tempLatLng = null;
        let lastSearchResultName = "";

        const map = L.map('map', { zoomControl: false }).setView([35.9, 14.4], 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        L.control.zoom({ position: 'topright' }).addTo(map);

        // API Init
        (async function init() {
            try {
                const res = await fetch('/api/secrets');
                const data = await res.json();
                sbClient = window.supabase.createClient(data.url, data.key);
                document.getElementById('status-init').style.display = 'none';
                document.getElementById('access-code-input').style.display = 'block';
                document.getElementById('login-btn').style.display = 'block';
            } catch (e) {
                document.getElementById('status-init').innerText = "Błąd API.";
            }
        })();

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            setTimeout(() => map.invalidateSize(), 300);
        }

        function handleLogin() {
            const code = document.getElementById('access-code-input').value;
            if(code) {
                USER_CODE = code;
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('display-code').innerText = code;
                syncFromDB();
            }
        }

        async function searchDirect() {
            const query = document.getElementById('search-input').value;
            if(!query) return;
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&countrycodes=mt&q=${encodeURIComponent(query)}`);
            const results = await res.json();
            if (results.length > 0) {
                const best = results[0];
                const lat = parseFloat(best.lat);
                const lon = parseFloat(best.lon);
                lastSearchResultName = best.display_name.split(',')[0];
                tempLatLng = { lat: lat, lng: lon };
                if(window.innerWidth <= 768) toggleSidebar();
                map.flyTo([lat, lon], 14);
                L.popup().setLatLng([lat, lon]).setContent(`<b>${best.display_name}</b><br><button style="background:#28a745; color:white; border:none; padding:10px; width:100%; border-radius:5px; margin-top:5px; font-weight:bold; cursor:pointer;" onclick="openAddModalFromSearch()">➕ Dodaj do trasy</button>`).openOn(map);
            }
        }

        function openAddModalFromSearch() {
            map.closePopup();
            populateDaySelect();
            document.getElementById('new-name').value = lastSearchResultName;
            document.getElementById('add-modal').style.display = 'flex';
        }

        async function syncFromDB() {
            updateStatus("Synchronizacja...");
            const { data } = await sbClient.from('locations').select('*').eq('user_code', USER_CODE).order('order_index');
            locations = data || [];
            if(locations.length > 0) maxDay = locations.reduce((max, p) => p.day_number > max ? p.day_number : max, 1);
            renderUI();
            updateStatus("Gotowe");
        }

        async function syncOrderToDB() {
            updateStatus("Zapisywanie...");
            const updates = [];
            document.querySelectorAll('.day-list').forEach(list => {
                const dayNum = parseInt(list.getAttribute('data-day'));
                const items = list.querySelectorAll('.location-item');
                items.forEach((item, index) => {
                    const id = parseInt(item.getAttribute('data-id'));
                    const loc = locations.find(l => l.id === id);
                    if(loc) {
                        loc.day_number = dayNum;
                        loc.order_index = index;
                        updates.push({ ...loc, user_code: USER_CODE });
                    }
                });
            });
            renderUI(); // Natychmiastowe odświeżenie badge START
            await sbClient.from('locations').upsert(updates);
            updateStatus("Zapisano");
        }

        function renderUI() {
            const container = document.getElementById('days-container');
            container.innerHTML = '';
            for(let d=1; d<=maxDay; d++) {
                const dayPoints = locations.filter(l => l.day_number === d).sort((a,b) => a.order_index - b.order_index);
                const section = document.createElement('div');
                section.className = 'day-section';
                section.innerHTML = `<div class="day-header">Dzień ${d}</div><ul class="day-list" data-day="${d}"></ul>`;
                container.appendChild(section);
                
                const list = section.querySelector('ul');
                dayPoints.forEach((p, idx) => {
                    const li = document.createElement('li');
                    li.className = `location-item cat-${p.category.toLowerCase()}`;
                    li.setAttribute('data-id', p.id);
                    
                    let badge = idx === 0 ? '<span class="badge-home">START</span>' : '';
                    
                    li.innerHTML = `
                        <div class="item-content">
                            <strong>${p.name} ${badge}</strong>
                            <div style="font-size:11px; color:#666">${p.description || ''}</div>
                        </div>
                        <div class="drag-handle">☰</div>
                    `;
                    
                    li.querySelector('.item-content').onclick = () => {
                        if(window.innerWidth <= 768) toggleSidebar();
                        map.flyTo([p.lat, p.lng], 15);
                    };
                    list.appendChild(li);
                });

                // --- KONFIGURACJA SORTABLE Z UCHWYTEM ---
                Sortable.create(list, { 
                    group: 'days', 
                    animation: 150, 
                    handle: '.drag-handle', // <--- TYLKO ZA TO MOŻNA CIĄGNĄĆ
                    onEnd: syncOrderToDB 
                });
            }
            renderMapMarkers();
        }

        function renderMapMarkers() {
            map.eachLayer(l => { if(l instanceof L.Marker || l instanceof L.Polyline) map.removeLayer(l); });
            const colors = ['#007bff', '#dc3545', '#6f42c1', '#fd7e14', '#28a745'];
            for(let d=1; d<=maxDay; d++) {
                const dayPoints = locations.filter(l => l.day_number === d).sort((a,b) => a.order_index - b.order_index);
                if(dayPoints.length === 0) continue;
                const path = [];
                dayPoints.forEach((p) => {
                    const marker = L.marker([p.lat, p.lng]).addTo(map);
                    marker.bindPopup(`<b>Dzień ${d}: ${p.name}</b>`);
                    path.push([p.lat, p.lng]);
                });
                if(path.length > 1) {
                    path.push(path[0]);
                    L.polyline(path, { color: colors[(d-1)%colors.length], weight: 4, dashArray: '10, 10' }).addTo(map);
                }
            }
        }

        map.on('click', (e) => {
            tempLatLng = e.latlng;
            document.getElementById('new-name').value = "";
            populateDaySelect();
            document.getElementById('add-modal').style.display = 'flex';
        });

        function populateDaySelect() {
            const sel = document.getElementById('new-day-select');
            sel.innerHTML = '';
            for(let i=1; i<=maxDay; i++) {
                const opt = document.createElement('option');
                opt.value = i; opt.text = `Dzień ${i}`;
                sel.appendChild(opt);
            }
        }

        async function confirmAdd() {
            const name = document.getElementById('new-name').value;
            if(!name) return;
            const day = parseInt(document.getElementById('new-day-select').value);
            const { data } = await sbClient.from('locations').insert([{
                user_code: USER_CODE, name: name, category: document.getElementById('new-category').value,
                description: document.getElementById('new-desc').value, lat: tempLatLng.lat, lng: tempLatLng.lng,
                day_number: day, order_index: locations.length
            }]).select();
            if(data) { locations.push(data[0]); closeModal(); renderUI(); }
        }

        function closeModal() { document.getElementById('add-modal').style.display = 'none'; }
        function updateStatus(m) { document.getElementById('status-text').innerText = m; }
        function addNewDay() { maxDay++; renderUI(); }
    </script>
</body>
</html>
